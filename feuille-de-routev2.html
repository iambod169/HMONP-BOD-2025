// Fonction principale pour appliquer les couleurs aux phases - CORRECTION IMPORTANTE
function applyPhaseColorsSimple() {
    console.log('Application des couleurs de phases...');
    
    const phases = document.querySelectorAll('.project-phase-msp');
    console.log(`Nombre de phases trouvées : ${phases.length}`);
    
    phases.forEach(function(phase, index) {
        const text = phase.textContent.trim().toUpperCase();
        console.log(`Phase ${index + 1}: "${text}"`);
        
        // Supprimer les anciennes classes de phase
        phase.classList.remove('phase-edl', 'phase-esq-faisa', 'phase-aps', 'phase-apd', 'phase-pc-pcm', 'phase-pro', 'phase-exe', 'phase-doe');
        
        // Appliquer la bonne classe selon le contenu
        if (text.includes('EDL') || text.includes('ÉTAT')) {
            phase.classList.add('phase-edl');
            console.log('Appliqué : phase-edl');
        } else if (text.includes('ESQ') || text.includes('FAISA') || text.includes('FAISABILITÉ') || text.includes('CANDIDATURE')) {
            phase.classList.add('phase-esq-faisa');
            console.log('Appliqué : phase-esq-faisa');
        } else if (text.includes('APS') && !text.includes('EXE')) {
            phase.classList.add('phase-aps');
            console.log('Appliqué : phase-aps');
        } else if (text.includes('APD') || text.includes('MEP')) {
            phase.classList.add('phase-apd');
            console.log('Appliqué : phase-apd');
        } else if (text.includes('PC') || text.includes('PERMIS') || text.includes('AO') || text.includes('NÉGOCIATION')) {
            phase.classList.add('phase-pc-pcm');
            console.log('Appliqué : phase-pc-pcm');
        } else if (text.includes('PRO') && !text.includes('EXE')) {
            phase.classList.add('phase-pro');
            console.log('Appliqué : phase-pro');
        } else if (text.includes('EXE') || text.includes('COORDINATION') || text.includes('APPLICATION')) {
            phase.classList.add('phase-exe');
            console.log('Appliqué : phase-exe');
        } else if (text.includes('DOE') || text.includes('COM') || text.includes('REVIT') || text.includes('FORMATION') || text.includes('DÉVELOPPEMENT') || text.includes('ATTENTE')) {
            phase.classList.add('phase-doe');
            console.log('Appliqué : phase-doe');
        } else {
            // Phase par défaut
            phase.classList.add('phase-aps');
            console.log('Appliqué par défaut : phase-aps');
        }
        
        console.log(`Classes finales: ${phase.className}`);
    });
    
    console.log('Application des couleurs terminée');
}

// Animation des points de timeline
document.querySelectorAll('.timeline-dot').forEach(dot => {
    dot.addEventListener('click', function() {
        // Retirer active de tous les points
        document.querySelectorAll('.timeline-dot').forEach(d => d.classList.remove('active'));
        // Ajouter active au point cliqué
        this.classList.add('active');
        
        // Animation des cartes (optionnel)
        const month = this.dataset.month;
        animateProjectCards(month);
    });
});

function animateProjectCards(month) {
    const cards = document.querySelectorAll('.project-card');
    cards.forEach((card, index) => {
        card.style.animation = 'none';
        setTimeout(() => {
            card.style.animation = `fadeInUp 0.6s ease forwards`;
            card.style.animationDelay = `${index * 0.1}s`;
        }, 50);
    });
}

// Animation initiale
window.addEventListener('load', () => {
    animateProjectCards('initial');
    
    // Animation spécifique pour les phases de projet
    setTimeout(() => {
        const phases = document.querySelectorAll('.project-phase-msp');
        phases.forEach((phase, index) => {
            phase.style.animationDelay = `${0.8 + (index * 0.1)}s`;
        });
    }, 100);
    
    // IMPORTANT: Appliquer les couleurs de phases après le chargement
    setTimeout(function() {
        applyPhaseColorsSimple();
    }, 1000);
});

// Interaction avec les barres d'activité
document.querySelectorAll('.activity-bar-msp').forEach(bar => {
    bar.addEventListener('mouseenter', function() {
        // Mettre en évidence la ligne correspondante
        const lane = this.closest('.activity-lane-msp');
        lane.style.backgroundColor = 'rgba(52, 152, 219, 0.05)';
        lane.style.borderLeftColor = '#3498db';
        
        // Animation de la phase
        const phase = this.querySelector('.project-phase-msp');
        if (phase) {
            phase.style.transform = 'scale(1.1)';
            phase.style.fontWeight = '700';
        }
    });
    
    bar.addEventListener('mouseleave', function() {
        const lane = this.closest('.activity-lane-msp');
        lane.style.backgroundColor = '';
        lane.style.borderLeftColor = '#193242';
        
        const phase = this.querySelector('.project-phase-msp');
        if (phase) {
            phase.style.transform = 'scale(1)';
            phase.style.fontWeight = '600';
        }
    });
});

// Fonction pour filtrer les projets par discipline
function filterProjects(discipline) {
    const cards = document.querySelectorAll('.project-card');
    cards.forEach(card => {
        if (discipline === 'all' || card.classList.contains(`discipline-${discipline}`)) {
            card.style.display = 'block';
            card.style.animation = 'fadeInUp 0.5s ease forwards';
        } else {
            card.style.display = 'none';
        }
    });
}

// Compteur de projets dynamique
function updateProjectCounter() {
    const visibleCards = document.querySelectorAll('.project-card:not([style*="display: none"])');
    const counter = document.querySelector('.projects-counter');
    if (counter) {
        counter.textContent = `${visibleCards.length} projets affichés`;
    }
}

// Observer pour les animations au scroll
const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
};

const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.classList.add('animate-in');
        }
    });
}, observerOptions);

// Observer les cartes de projets
document.querySelectorAll('.project-card').forEach(card => {
    observer.observe(card);
});

// Amélioration de l'accessibilité
document.querySelectorAll('.activity-bar-msp').forEach(bar => {
    bar.setAttribute('tabindex', '0');
    bar.setAttribute('role', 'button');
    
    bar.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            bar.click();
        }
    });
});

// Gestion du mode sombre (optionnel)
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
}

// Restaurer le mode sombre au chargement
if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark-mode');
}

// Gestion avancée des phases avec tooltips et interactions
function createPhaseTooltips() {
    const tooltipInfo = {
        'phase-edl': 'État des Lieux - Analyse de l\'existant et diagnostic initial',
        'phase-esq-faisa': 'Esquisse/Faisabilité - Études préliminaires et analyse de faisabilité',
        'phase-aps': 'Avant-Projet Sommaire - Définition architecturale générale du projet',
        'phase-apd': 'Avant-Projet Détaillé - Précision des choix architecturaux et techniques',
        'phase-pc-pcm': 'Permis de Construire - Dossier réglementaire et autorisations administratives',
        'phase-pro': 'Projet - Plans détaillés et spécifications pour consultation des entreprises',
        'phase-exe': 'Projet d\'Exécution - Plans d\'exécution très détaillés pour la construction',
        'phase-doe': 'Dossier Ouvrages Exécutés - Documentation finale et réception des travaux'
    };
    
    const phaseElements = document.querySelectorAll('.project-phase-msp');
    
    phaseElements.forEach(phaseElement => {
        const phaseClasses = Array.from(phaseElement.classList);
        const phaseClass = phaseClasses.find(cls => cls.startsWith('phase-'));
        
        if (phaseClass && tooltipInfo[phaseClass]) {
            phaseElement.setAttribute('title', tooltipInfo[phaseClass]);
            phaseElement.style.cursor = 'help';
        }
        
        // Interaction au clic pour afficher plus d'infos
        phaseElement.addEventListener('click', function(e) {
            e.stopPropagation();
            showPhaseDetails(this);
        });
    });
}

// Affichage des détails de phase
function showPhaseDetails(phaseElement) {
    const phaseText = phaseElement.textContent;
    const rect = phaseElement.getBoundingClientRect();
    
    // Créer une popup temporaire avec les détails
    const popup = document.createElement('div');
    popup.style.cssText = `
        position: fixed;
        top: ${rect.bottom + 10}px;
        left: ${rect.left}px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        z-index: 9999;
        font-size: 0.85rem;
        max-width: 300px;
        line-height: 1.4;
        font-family: 'Barlow', sans-serif;
    `;
    
    const phaseClasses = Array.from(phaseElement.classList);
    const phaseClass = phaseClasses.find(cls => cls.startsWith('phase-'));
    
    let description = 'Phase de projet architectural';
    let details = '';
    
    if (phaseClass === 'phase-edl') {
        description = 'État des Lieux';
        details = 'Analyse de l\'existant, relevés architecturaux, diagnostic technique et réglementaire initial.';
    }
    if (phaseClass === 'phase-esq-faisa') {
        description = 'Esquisse / Faisabilité';
        details = 'Études préliminaires, analyse de faisabilité technique et financière, premières propositions.';
    }
    if (phaseClass === 'phase-aps') {
        description = 'Avant-Projet Sommaire';
        details = 'Définition architecturale générale, surfaces, volumes, implantation et choix constructifs principaux.';
    }
    if (phaseClass === 'phase-apd') {
        description = 'Avant-Projet Détaillé';
        details = 'Précision des choix architecturaux et techniques, plans détaillés, matériaux, estimation financière.';
    }
    if (phaseClass === 'phase-pc-pcm') {
        description = 'Permis de Construire';
        details = 'Constitution du dossier réglementaire, plans conformes, pièces administratives et autorisations.';
    }
    if (phaseClass === 'phase-pro') {
        description = 'Projet (PRO)';
        details = 'Plans détaillés avec spécifications techniques complètes pour consultation des entreprises.';
    }
    if (phaseClass === 'phase-exe') {
        description = 'Projet d\'Exécution';
        details = 'Plans d\'exécution très détaillés pour la construction, coordination tous corps d\'état, DCE.';
    }
    if (phaseClass === 'phase-doe') {
        description = 'Dossier Ouvrages Exécutés';
        details = 'Documentation finale, plans conformes à l\'exécution, notices, garanties et réception.';
    }
    
    popup.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <div style="width: 40px; height: 20px; ${phaseElement.style.cssText}; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; font-weight: bold;">
                ${phaseText.split(' ')[0]}
            </div>
            <strong style="color: #2c3e50;">${phaseText}</strong>
        </div>
        <div style="color: #34495e; margin-bottom: 8px; font-weight: 600;">${description}</div>
        <div style="color: #7f8c8d; font-size: 0.8rem;">${details}</div>
        <div style="margin-top: 10px; font-size: 0.7rem; color: #95a5a6; text-align: center;">
            Cliquez ailleurs pour fermer
        </div>
    `;
    
    document.body.appendChild(popup);
    
    // Supprimer la popup après 5 secondes
    setTimeout(() => {
        if (popup.parentNode) {
            popup.parentNode.removeChild(popup);
        }
    }, 5000);
    
    // Supprimer la popup au clic ailleurs
    document.addEventListener('click', function removePopup() {
        if (popup.parentNode) {
            popup.parentNode.removeChild(popup);
        }
        document.removeEventListener('click', removePopup);
    });
}

// Statistiques des phases
function generatePhaseStats() {
    const phaseElements = document.querySelectorAll('.project-phase-msp');
    const phaseCount = {};
    
    phaseElements.forEach(phaseElement => {
        const phaseClasses = Array.from(phaseElement.classList);
        const phaseClass = phaseClasses.find(cls => cls.startsWith('phase-'));
        
        if (phaseClass) {
            phaseCount[phaseClass] = (phaseCount[phaseClass] || 0) + 1;
        }
    });
    
    console.log('Répartition des phases:', phaseCount);
    
    // Ajouter les stats à la légende des phases
    const legend = document.querySelector('.phases-legend');
    if (legend && Object.keys(phaseCount).length > 0) {
        let statsHTML = '<div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6;">';
        statsHTML += '<div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 8px;"><i class="fas fa-chart-bar"></i> <strong>Répartition dans les projets :</strong></div>';
        
        const phaseNames = {
            'phase-edl': 'EDL',
            'phase-esq-faisa': 'ESQ/FAISA',
            'phase-aps': 'APS',
            'phase-apd': 'APD',
            'phase-pc-pcm': 'PC/PCM',
            'phase-pro': 'PRO',
            'phase-exe': 'EXE',
            'phase-doe': 'DOE'
        };
        
        const statsParts = [];
        for (const [phaseClass, count] of Object.entries(phaseCount)) {
            if (phaseNames[phaseClass]) {
                statsParts.push(`<span style="color: #2c3e50; font-weight: 600;">${phaseNames[phaseClass]}</span> <span style="background: #3498db; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem;">${count}</span>`);
            }
        }
        
        statsHTML += '<div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 0.8rem;">' + statsParts.join(' ') + '</div>';
        statsHTML += '</div>';
        legend.insertAdjacentHTML('beforeend', statsHTML);
    }
}

// Initialisation complète du système
function initializeCompleteSystem() {
    console.log('Initialisation du système complet...');
    
    // Appliquer les couleurs des phases
    applyPhaseColorsSimple();
    
    // Créer les tooltips après l'application des couleurs
    setTimeout(() => {
        createPhaseTooltips();
    }, 200);
    
    // Générer les statistiques
    setTimeout(() => {
        generatePhaseStats();
    }, 500);
    
    console.log('Système complet initialisé');
}

// Ré-appliquer les couleurs si nécessaire
function forceReapplyColors() {
    console.log('Force réapplication des couleurs...');
    applyPhaseColorsSimple();
    createPhaseTooltips();
}

// Attendre que tout soit chargé puis initialiser
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeCompleteSystem, 500);
});

// Aussi appliquer au chargement de la fenêtre (sécurité)
window.addEventListener('load', function() {
    setTimeout(initializeCompleteSystem, 1000);
});

// Réappliquer toutes les 2 secondes les premières 10 secondes (pour sécurité)
let retryCount = 0;
const retryInterval = setInterval(() => {
    retryCount++;
    console.log(`Tentative de réapplication ${retryCount}/5...`);
    
    const phases = document.querySelectorAll('.project-phase-msp');
    const coloredPhases = document.querySelectorAll('.project-phase-msp[class*="phase-"]');
    
    if (phases.length > 0 && coloredPhases.length === 0) {
        console.log('Phases détectées mais pas colorées, réapplication...');
        forceReapplyColors();
    }
    
    if (retryCount >= 5) {
        clearInterval(retryInterval);
        console.log('Arrêt des tentatives de réapplication');
    }
}, 2000);

// Observer pour détecter les nouveaux éléments ajoutés dynamiquement
const phaseObserver = new MutationObserver(function(mutations) {
    let shouldReapply = false;
    
    mutations.forEach(function(mutation) {
        if (mutation.type === 'childList') {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1 && 
                    (node.classList.contains('project-phase-msp') || 
                     node.querySelector('.project-phase-msp'))) {
                    shouldReapply = true;
                }
            });
        }
    });
    
    if (shouldReapply) {
        console.log('Nouveaux éléments détectés, réapplication...');
        setTimeout(initializeCompleteSystem, 100);
    }
});

phaseObserver.observe(document.body, {
    childList: true,
    subtree: true
});

// Export des fonctions pour usage externe et débogage
window.PhaseManagement = {
    applyColors: applyPhaseColorsSimple,
    init: initializeCompleteSystem,
    forceReapply: forceReapplyColors,
    showStats: generatePhaseStats
};

// Test manuel disponible dans la console
window.testPhaseColors = function() {
    console.log('=== TEST MANUEL DES COULEURS DE PHASES ===');
    forceReapplyColors();
    
    setTimeout(() => {
        const phases = document.querySelectorAll('.project-phase-msp');
        const coloredPhases = document.querySelectorAll('.project-phase-msp[class*="phase-"]');
        console.log(`Total des phases: ${phases.length}`);
        console.log(`Phases colorées: ${coloredPhases.length}`);
        
        if (phases.length === coloredPhases.length) {
            console.log('✅ Toutes les phases sont correctement colorées');
        } else {
            console.log('❌ Certaines phases ne sont pas colorées');
            phases.forEach((phase, index) => {
                const hasColor = Array.from(phase.classList).some(cls => cls.startsWith('phase-'));
                if (!hasColor) {
                    console.log(`Phase sans couleur: ${index + 1} - "${phase.textContent}"`);
                }
            });
        }
    }, 1000);
};

console.log('Script de gestion des phases chargé. Tapez window.testPhaseColors() pour tester.');
